# M3 — Check-In Write Path (Implementation Summary)
Date: 2025-12-23
Run: M3-20251223-1755

## Goal
Allow visitors to scan a portal, pick a duration + mood, optionally add a recognizability hint, confirm an alias, and create a check-in that immediately appears in the place gallery.

## Implemented
- Extended the `check_ins` table with duration, mood, and recognizability hint columns (mood defaults to `open` for legacy rows).
- Added deterministic server helpers for ensuring users/place profiles exist, expiring prior check-ins, and inserting the new record.
- Introduced client identity storage (`localStorage`) plus a wheel-based duration picker (`@ncdai/react-wheel-picker`), mood selector, hint input, and alias confirmation UI on `/place/[slug]`.
- Created a server action-style API route (`POST /api/check-ins`) that validates payloads and writes via Drizzle.
- Updated locales with all copy for the new flow and documented the milestone.

## Files Added / Updated
- Added: `src/components/check-in-flow.tsx`, `src/components/wheel-picker.tsx`
- Added: `src/lib/alias.ts`, `src/lib/checkins.ts`, `src/lib/identity.ts`
- Added: `src/db/queries/checkins.ts`, `src/app/api/check-ins/route.ts`
- Updated: `src/app/place/[slug]/page.tsx`, `src/db/schema.ts`, `src/locales/*.json`, `package.json`, `components.json`, drizzle meta + migration files

## Behavioral Notes
- `/place/[slug]` now shows a “Start check-in” CTA. Opening it walks through duration → mood → optional hint → alias confirmation.
- Alias regeneration is unlimited and happens client-side; the confirmed alias is persisted to `place_profiles` on submit.
- After confirming, the flow ensures a global user id, expires any prior check-ins, writes the new record, and refreshes the gallery without navigating away.

## Schema / DB Notes
- New columns: `check_ins.duration_minutes`, `check_ins.mood` (default `'open'`), `check_ins.recognizability_hint`.
- Commands run: `npx drizzle-kit generate`, `npx drizzle-kit migrate`.

## Known Issues / Follow-ups
- Recognizability hints are stored but still not rendered in the gallery.
- Mood taxonomy is placeholder-only; future milestones may refine copy and visuals.
- Alias edits outside the check-in flow remain unsupported.

## Next
- Move toward M4 (profile polish + moderation) or continue M3 by surfacing recognizability hints and ordering freshly checked-in cards to the top.

