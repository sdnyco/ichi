# M5 — Safety Track A (Block & Report)
Date: 2025-12-25  
Run: M5-20251225-1525

## Goal
Provide a minimal, user-facing safety surface so people can block or report others directly from the read-only profile overlay, and ensure blocked users disappear from all gallery contexts.

## Implemented
- **Schema:** Added `user_blocks` (mutual invisibility pairs) and `user_reports` (persisted reports with metadata). Generated and applied the associated Drizzle migration.
- **Visibility enforcement:** `getActiveGalleryForPlace` now takes an optional `viewerUserId` and excludes any check-ins where either party has blocked the other. The place loader reads the viewer id from the new `ichi_user_id` cookie, so galleries respect blocks server-side.
- **Safety actions API:** Created `/api/blocks` (POST block, DELETE unblock) and `/api/reports` (POST report) backed by new query helpers in `src/db/queries/safety.ts`. Reports capture reason code + optional notes plus contextual IDs (place/check-in when available).
- **Other profile UI:** The read-only profile overlay now shows a top-bar “Safety” menu (block/unblock + report). Blocking confirms, calls the API, closes the overlay, and forces a gallery refresh so the user vanishes immediately. Reports open a lightweight modal with reason selector + optional free text. Hook pills now render localized labels, and the overlay no longer shows autosave status in read-only mode.
- **Identity cookie:** `getOrCreateLocalUserId` now mirrors the generated id into a long-lived cookie so server components can identify the viewer.

## Known Issues / Next
- Block/report actions rely on client-provided user ids; server-side auth is still device-based.
- Admin tooling for reviewing reports is still pending (future M5 runs).
- Safety menu currently lives only on the other-user profile; gallery-level shortcuts can arrive later once UX stabilizes.

