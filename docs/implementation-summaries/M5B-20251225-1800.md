# M5 Track B — Admin & Moderation (2025-12-25 18:00)

## Summary
- Added an internal `/admin` panel with login/logout, middleware guarding, and sections for reports, users, portals, and check-ins.
- Expanded moderation data: `users` now tracks `lastSeenAt`, `isBanned`, `bannedAt`, `banReason`; `user_reports` now stores `status`, `resolvedAt`, `resolvedBy`.
- Implemented ban enforcement on gallery reads plus all key write flows (check-ins, profile updates, traits). Added clear “Account disabled” UX states for user actions.
- Wired admin quick actions for report workflow, user bans, portal enable/disable, and “End now” on active check-ins.
- Persisted viewer activity with `lastSeenAt` touches on place visits, blocks, reports, and check-in mutations.

## Schema changes
- `users`: `last_seen_at` (timestamptz), `is_banned` (boolean, default false), `banned_at` (timestamptz), `ban_reason` (text).
- `user_reports`: `status` (`new|reviewing|actioned|dismissed`, default `new`), `resolved_at` (timestamptz), `resolved_by` (text).
- Migration file: `drizzle/0005_internal_admin_panel.sql` with updated snapshot metadata.

## Admin access & routes
- Set `ADMIN_TOKEN` in `.env.local`. Both middleware and the `(panel)` route group layout validate the httpOnly `ichi_admin` cookie; requests without a valid session are redirected to `/admin/login`.
- `/admin/login`: dark-theme token form that issues an 8h cookie.
- `/admin/logout`: clears the cookie and redirects to the login screen.
- `/admin`: dashboard with links to:
  - `/admin/reports`: review/filter reports, update statuses, quick-ban users, toggle linked portals.
  - `/admin/users`: search by userId, view timeline + reports, ban/unban with optional reason, list recent signups.
  - `/admin/portals`: search by code prefix, enable/disable portals.
  - `/admin/check-ins`: tabbed active/expired lists with “End now” action for active rows.

## Enforcement notes
- `getActiveGalleryForPlace` now excludes banned users; banned viewers also see disabled flows (API returns `account_disabled`, UI shows notifications).
- Blocking, reporting, and check-in mutations touch `users.lastSeenAt` so admins can see recent activity.
- All profile mutations (`/api/me/active-checkin`, `/api/me/place-profile`, `/api/me/user-traits`) and check-in creation enforce ban checks with consistent 403 responses.
- Portal ingress (`/p/[code]`) shows an inactive screen when a code exists but `is_enabled = false`, instead of a generic 404.

## Known issues / follow-ups
- Admin UI is intentionally minimal (no pagination, no optimistic updates). Consider adding pagination/export if report volume grows.
- Report list quick actions currently refresh the whole page; enhancing with progressive UI or toasts would improve UX.
- Ban reasons are free text with no audit log. Future work: capture admin identifier or structured reasons.
- “End now” does not notify affected users yet; consider adding push/email if required.

