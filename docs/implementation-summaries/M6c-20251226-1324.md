# M6c — Pings (Explicit) + Rate Limits + Email (Identity-Light)

## Schema Additions
- `place_profiles.contactEmail` (nullable text) stores the self-managed, place-scoped reachability email. It is only surfaced inside the owner’s profile sheet, never to other users.
- Added `ping_events` with `(place_id, day_key)` unique constraint plus metadata (`sender_user_id`, `sender_check_in_id`, `max_recipients`, `status`). One row == one explicit ping attempt per place/day.
- Added `ping_recipients` to capture the concrete recipients (`recipient_user_id`, `recipient_email`) per event plus creation timestamps for receive-limit lookups. Unique constraint prevents duplicate recipients within the same event and an index on `(recipient_user_id, created_at)` powers rolling-window counts.

## Rate Limits
- **Send limit:** Max one ping per place per calendar day in `"Europe/Berlin"`, enforced by pre-checking `ping_events` and the DB-level unique constraint on `(place_id, day_key)` where `day_key` is formatted `YYYY-MM-DD` in that timezone.
- **Receive limit:** Each recipient can appear in at most three `ping_recipients` rows within a rolling 7-day window (`now - 7d`). Eligibility uses the rolling count and a second guard reruns the count inside the send transaction to avoid races.

## Eligibility Rules
- Candidates must be anchored, unbanned, not the sender, not blocked (either direction), and have a valid `contactEmail`.
- If availability is disabled, we treat the user as always reachable; otherwise we reuse the weekly schedule evaluator from M6b.1.
- The place must be empty (no other active check-ins) and the daily send limit must still be available. Eligible recipients are sorted by least-recently pinged (defaulting to deterministic userId ordering) and capped at the configurable `PING_MAX_RECIPIENTS` (default 3).

## Email Payload
- Emails are sent via Resend using `RESEND_API_KEY` and `PING_EMAIL_FROM`. Each email carries only: place name, an approximate local expiry (`expiresAt` rendered in Europe/Berlin), the sender’s mood label, and a deep link to `/place/{slug}` built from `PING_PLACE_BASE_URL` (falls back to localhost in dev).
- There is no sender alias, hook data, or recipient list hinting. If delivery fails, the `ping_events` row is marked `status='failed'` and the client receives `reason=email_failed`, but the unique send slot remains consumed per spec.

## UI & Flow
- The self-profile sheet now reveals a contact email input when anchoring is enabled. It validates format client-side, auto-saves with the rest of the profile, and shows an inline warning (“Add email to be reachable”) when anchored but missing/invalid.
- The check-in flow receives server-computed ping eligibility (only when the user has an active check-in, the place is empty, recipients exist, and rate limits allow it). A single CTA (“Ping anchored users”) posts to `/api/pings`, shows success/no-recipient/send-limit toasts, and hides once a ping is consumed.
- Both the eligibility endpoint and the send action verify check-in ownership via the `ichi_user_id` cookie, re-check emptiness, and recompute recipients at action time so stale client state cannot leak anchored counts.

## Known Limitations
- No reply channel, muting, or preference UI—emails are one-way notifications.
- Pings stay email-only; there are no hooks/identity hints beyond the sender’s mood and estimated tenure.
- If an email send fails, the place’s daily ping slot is still considered used until the next Berlin day. Future admin tooling should surface `ping_events`/`ping_recipients` for read-only audits.


