# Maintainability Audit – M7b Prep (2026‑01‑07)

_Target location: `docs/maintainability-audit/M7b-prep-20260107-1715.md`_

## 1. Large-file map

1. `src/components/expanded-profile-sheet.tsx` (≈1367 LOC)  
   - Why it’s large: One component owns identity editing, autosave orchestration, availability editor, and all helper logic.  
   - Risk: **High** – multiple concurrent PATCH calls, local timers, and optimistic updates make regressions likely.  
   - Safe extraction candidates:
     - Move `normalizeAvailabilityWeekly`, `minutesToTimeInput`, and `timeInputToMinutes` into `src/lib/availability.ts`.
     - Extract a `useProfileSheetAutosave` hook that encapsulates `markSaving`/`markSuccess`/`sendPatch`.
     - Split the UI into `IdentitySection`, `HooksSection`, and `AvailabilitySection` components.

2. `src/components/place-gallery.tsx` (≈777 LOC)  
   - Why it’s large: Combines gallery bucketing, carousel behavior, card rendering, ticker animation, and relative-time math.  
   - Risk: **Medium-high** – complex timers/refs plus unused debug scaffolding obscure intent.  
   - Safe extraction candidates:
     - Move `GalleryCard`, `HookTickerList`, and `CarouselInitialScroll` into dedicated files.
     - Promote `formatRelativeTime`/`formatCompactDuration` into `src/lib/time.ts` for reuse.
     - Delete unused debug constructs (`galleryDebugCounter`, duplicate `"placeholder"` union, no-op effect).

3. `src/components/place-check-in-drawer.tsx` (≈502 LOC)  
   - Why it’s large: Multi-step wizard, identity seeding, API submission, and error presentation all live together.  
   - Risk: **Medium-high** – `startTransition` + fetch chains are hard to reason about, and validation errors are sprinkled through JSX.  
   - Safe extraction candidates:
     - Move `STEP_IDS` and per-step copy into a config module.
     - Extract each wizard step (`DurationStep`, `MoodStep`, `HintStep`, `AliasStep`) into components.
     - Wrap `/api/me/place-context` + `/api/check-ins` calls in a `usePlaceCheckIn` hook shared with other clients.

4. `src/components/profile/other-profile-sheet.tsx` (≈492 LOC)  
   - Why it’s large: Loads target data, renders status cards, and embeds safety/report flows plus dialog state.  
   - Risk: **Medium** – multiple fetch chains (profile load, block/unblock, report) sit in one component with shared state.  
   - Safe extraction candidates:
     - Create a `useOtherProfileData` hook for loading, timestamp updates, and memoized labels.
     - Extract the safety menu + report form into subcomponents.
     - Share hook/mood label formatting helpers with `place-gallery.tsx`.

5. `src/db/schema.ts` (≈358 LOC)  
   - Why it’s large: Every Drizzle table, index, and relation sits in one module.  
   - Risk: **Medium** – any schema change touches unrelated tables; merge conflicts likely.  
   - Safe extraction candidates:
     - Split schema by domain (`places.ts`, `pings.ts`, `safety.ts`, etc.) and re-export from `schema.ts`.
     - Introduce shared builders for repeated timestamp/index definitions.
     - Export typed helpers (`type Place`, `type CheckIn`) per table instead of referencing `schema.ts` everywhere.

6. `src/lib/hooks-catalog.ts` (≈346 LOC)  
   - Why it’s large: Contains the entire hook taxonomy plus derived maps.  
   - Risk: **Low-medium** – manual edits risk duplicate IDs or stale translation keys.  
   - Safe extraction candidates:
     - Move the raw catalog to JSON and validate via a build-time script.
     - Generate `HOOKS_BY_CATEGORY`/`HOOK_LABEL_BY_ID` from one helper to avoid double iteration.
     - Add a `getHookLabel(locale, id)` helper so components don’t reimplement label lookups.

7. `src/components/place-ping-panel.tsx` (≈314 LOC)  
   - Why it’s large: Tracks active check-ins, ping eligibility, dismissal state, and CTA/status rendering.  
   - Risk: **Medium** – multiple fetches (place context + eligibility) with manual dedupe and limited UI errors.  
   - Safe extraction candidates:
     - Extract `usePingEligibility` (handles dedupe, aborts, and status).
     - Move the status banner into a pure `PingStatusNotice` component.
     - Wrap localStorage helpers (`PING_DISMISS_KEY_PREFIX`) in a utility for reuse/testing.

8. `src/app/admin/(panel)/reports/page.tsx` (≈290 LOC)  
   - Why it’s large: Server component handles filters, list rendering, and per-report mutation forms inline.  
   - Risk: **Medium** – repeated markup + nested forms make regressions easy when adjusting admin UI.  
   - Safe extraction candidates:
     - Pull the filter form into `ReportsFilter`.
     - Extract `ReportCard`/`ReportActions` components.
     - Share `STATUS_LABELS` between this file and other admin surfaces.

9. `src/app/api/me/place-profile/route.ts` (≈286 LOC)  
   - Why it’s large: Validates every optional payload field, normalizes input, and runs DB updates in one handler.  
   - Risk: **Medium-high** – manual guards are easy to forget (e.g., new fields), and the catch-all 500 hides root causes.  
   - Safe extraction candidates:
     - Move alias/hooks/email/availability validators to `src/lib/profile-validation.ts`.
     - Extract an `applyPlaceProfileUpdates` helper that returns the Drizzle update payload.
     - Introduce typed error helpers so responses stay consistent across profile APIs.

10. `src/app/api/pings/route.ts` (≈271 LOC)  
    - Why it’s large: Combines validation, rate limiting, transactional inserts, email sending, and error logging.  
    - Risk: **High** – a single failure path can leave events half-written or emails unsent with minimal caller feedback.  
    - Safe extraction candidates:
      - Move request validation + logging into `lib/pings-server.ts`.
      - Relocate `executePingTransaction` to `src/db/queries/pings.ts` and expose a typed result.
      - Replace ad-hoc string codes with a discriminated union so clients can branch predictably.

## 2. Dead/unused suspects

- **`src/components/place-gallery.tsx` – unused `galleryDebugCounter` (confidence: high)**  
  Declared but never read; `rg` shows no references beyond the definition. Safe to delete to avoid confusion.

```33:36:src/components/place-gallery.tsx
let galleryDebugCounter = 0
```

- **`src/components/place-gallery.tsx` – promotion flags never flip (confidence: medium)**  
  `hasIncompleteProfile` and `withinProfileTtl` are hardcoded to `false`, so the “promotionMoment” branch only responds to `isJustCheckedIn` or the item count. If the intent was to surface incomplete profiles, that path is dead today.

```238:251:src/components/place-gallery.tsx
const hasIncompleteProfile = false
const withinProfileTtl = false

const promotionMoment =
  isJustCheckedIn ||
  (selfActive && hasIncompleteProfile && withinProfileTtl) ||
  visibleOtherCount === 1
```

- **`src/components/place-gallery.tsx` – stored carousel API w/ no usage (confidence: medium-high)**  
  `setCarouselApi` only feeds a no-op effect (`useEffect(() => {}, [carouselApi])`), so the extra state/ref churn is legacy instrumentation.

```102:110:src/components/place-gallery.tsx
const [carouselApi, setCarouselApi] = useState<CarouselApi | null>(null)
…
useEffect(() => {}, [carouselApi])
```

## 3. Hardening hotspots

- **`ExpandedProfileSheet` uncontrolled place-context fetch & autosave retries**  
  Fetch fires every time the sheet opens, with no abort if the user closes it mid-flight; repeated `sendPatch` calls depend on `userId` presence and only log to console on error (`context_error`). Suggested action: wrap fetch/patch calls in an AbortController keyed by `{placeId,userId}`, gate retries, and surface errors in the status bar instead of `console.error`.

```213:245:src/components/expanded-profile-sheet.tsx
const response = await fetch(`/api/me/place-context?${params.toString()}`)
if (!response.ok) {
  throw new Error("failed_to_load_context")
}
…
fetchContext(id)
```

- **`PlaceCheckInDrawer` blindly refetches `/api/me/place-context` on mount**  
  The drawer’s effect triggers `refreshActiveCheckin` immediately and after submits, but failures only log to console. Suggested action: add AbortController support plus a visible error state so failed refreshes don’t leave stale “hasActiveCheckin” flags.

```100:117:src/components/place-check-in-drawer.tsx
const response = await fetch(`/api/me/place-context?${params.toString()}`)
if (!response.ok) {
  throw new Error("place_context_failed")
}
…
useEffect(() => {
  void refreshActiveCheckin()
}, [refreshActiveCheckin])
```

- **`PlacePingPanel` networking is silent-on-error**  
  Both `refreshActiveCheckin` and `fetchPingEligibility` swallow errors after logging, so users never see when eligibility is stale or a request failed. Suggested action: expose a `pingStatus` variant for fetch failures and add retry/backoff logic so UI doesn’t freeze silently.

```123:142:src/components/place-ping-panel.tsx
if (!response.ok) {
  …
  throw new Error("place_context_failed")
}
…
} catch (error) {
  if ((error as DOMException)?.name === "AbortError") return
  console.error(error)
}
```

- **`/api/me/place-profile` collapses all unexpected errors into `unknown_error`**  
  Any thrown error other than `AccountDisabledError` returns a generic 500 with no classification, making client UX and alerting difficult. Suggested action: add structured logging + error codes (e.g., `validation_failed`, `db_write_failed`) so autosave UI can differentiate user vs server issues.

```223:229:src/app/api/me/place-profile/route.ts
} catch (error) {
  if (error instanceof AccountDisabledError) {
    return NextResponse.json({ error: "account_disabled" }, { status: 403 })
  }
  console.error(error)
  return NextResponse.json({ error: "unknown_error" }, { status: 500 })
}
```

- **`/api/pings` handles email sending inline without queue/backoff**  
  The handler performs the transactional insert and then immediately calls `sendPingEmails`; a transient email failure both flips the DB row to `failed` and returns 500, but the request is retried manually by the user with no dedupe. Suggested action: move email dispatch to a background job/outbox (or at least add exponential backoff + idempotent events) so retries don’t create duplicate `ping_events`.

```138:186:src/app/api/pings/route.ts
await sendPingEmails({ … })
…
} catch (error) {
  console.error("ping_email_failed", error)
  await db.update(pingEvents).set({ status: "failed" })
  …
  return NextResponse.json({ ok: false, reason: "email_failed" }, { status: 500 })
}
```

## 4. Minimal “safe cleanup” list (PR-sized)

- **Trim unused gallery scaffolding** (`src/components/place-gallery.tsx`): remove `galleryDebugCounter`, duplicate `"placeholder"` union member, and the empty `useEffect` tied to `carouselApi`. Pure dead-code removal, no behavior change.

- **Hoist availability/time helpers**: move `normalizeAvailabilityWeekly`, `minutesToTimeInput`, and `timeInputToMinutes` from `expanded-profile-sheet.tsx` into `src/lib/availability.ts` (re-exporting where needed). All call sites already treat them as pure functions, so relocating is mechanical.

- **Share relative-time utilities**: lift `formatRelativeTime`/`formatCompactDuration` from `place-gallery.tsx` into `src/lib/time.ts`, then import them in gallery + profile surfaces instead of duplicating logic.

- **Centralize place-context query building**: create a small helper (e.g., `buildPlaceContextQuery(userId, placeId)`) and reuse it in `ExpandedProfileSheet`, `PlaceCheckInDrawer`, and `PlacePingPanel` to eliminate repeated `new URLSearchParams` snippets and subtle inconsistencies.